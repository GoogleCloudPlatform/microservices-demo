
services:
  # Configuration for the CartService
  cartservice:
    build:
      context: ./src/cartservice/src
      dockerfile: Dockerfile
    image: uadeel421/reliance-cartservice
    container_name: cartservice-azmysql
    ports:
      - "5000:8080"
    env_file:
      - ./src/cartservice/src/.env
    healthcheck:
      test: ["CMD", "/usr/bin/grpc_health_probe", "-addr=:8080"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
  # Configuration for the ProductCatalogService
  productcatalogservice:
    build:
      context: ./src/productcatalogservice
      dockerfile: Dockerfile
    image: uadeel421/reliance-productcatalogservice
    container_name: productcatalogservice-app
    ports:
      - "3550:3550"
    env_file:
      - ./src/productcatalogservice/.env  
    volumes:
      - ./src/productcatalogservice/ssl:/ssl:ro
    restart: always
    healthcheck:
      test: ["CMD", "/bin/sh", "-c", "grpc_health_probe -addr=localhost:3550"]
      interval: 10s
      timeout: 5s
      retries: 5
  currencyservice:
    build:
      context: ./src/currencyservice # Path to Dockerfile for currencyservice
      dockerfile: Dockerfile
    image: uadeel421/reliance-currencyservice
    container_name: currencyservice-app
    ports:
      - "7000:7000" # Map host port 7000 to container's internal port 7000
    environment:
      - PORT=7000
      - DISABLE_PROFILER=true
    restart: always
    healthcheck: # Simple health check for Node.js gRPC service
      test: ["CMD", "/usr/bin/grpc_health_probe", "-addr=:7000"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Configuration for the Frontend Service
  frontend:
    build:
      context: ./src/frontend
      dockerfile: Dockerfile
    image: uadeel421/reliance-frontend
    container_name: frontend-app
    ports:
      - "8081:8080"
    depends_on:
      cartservice:
        condition: service_healthy
      productcatalogservice:
        condition: service_healthy
      currencyservice:
        condition: service_healthy
    # --- CORRECTED SERVICE ADDRESSES ---
    environment:
      - PORT=8080
      - PRODUCT_CATALOG_SERVICE_ADDR=productcatalogservice:3550
      - CURRENCY_SERVICE_ADDR=currencyservice:7000
      - CART_SERVICE_ADDR=cartservice:8080
      - RECOMMENDATION_SERVICE_ADDR=recommendationservice:8080
      - SHIPPING_SERVICE_ADDR=shippingservice:50051
      - CHECKOUT_SERVICE_ADDR=checkoutservice:5050
      - AD_SERVICE_ADDR=adservice:9555
      - PAYMENT_SERVICE_ADDR=paymentservice:50051
      - EMAIL_SERVICE_ADDR=emailservice:5000 # Port corrected to 5000
      - SHOPPING_ASSISTANT_SERVICE_ADDR=shoppingassistantservice:5050
    restart: always

  # Configuration for the Shipping Service
  shippingservice:
    build:
      context: ./src/shippingservice
      dockerfile: Dockerfile
    image: uadeel421/reliance-shippingservice
    container_name: shippingservice-app
    ports:
      - "50051:50051"
    restart: always
    healthcheck:
      test: ["CMD", "/usr/bin/grpc_health_probe", "-addr=:50051"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Configuration for the Checkout Service
  checkoutservice:
    build: ./src/checkoutservice
    image: uadeel421/reliance-checkoutservice
    container_name: checkoutservice-app
    ports:
      - "5050:5050"
    env_file:
      - ./src/checkoutservice/.env
    volumes:
      - ./src/productcatalogservice/ssl:/ssl:ro
    # --- CORRECTED SERVICE ADDRESSES ---
    environment:
      - PORT=5050
      - PRODUCT_CATALOG_SERVICE_ADDR=productcatalogservice:3550
      - SHIPPING_SERVICE_ADDR=shippingservice:50051
      - PAYMENT_SERVICE_ADDR=paymentservice:50051
      - EMAIL_SERVICE_ADDR=emailservice:5000
      - CURRENCY_SERVICE_ADDR=currencyservice:7000
      - CART_SERVICE_ADDR=cartservice:8080 
    restart: always
    healthcheck:
      test: ["CMD", "/usr/bin/grpc_health_probe", "-addr=:5050"]
      interval: 10s
      timeout: 5s
      retries: 5

  adservice:
    build:
      context: ./src/adservice
      dockerfile: Dockerfile
    image: uadeel421/reliance-adservice
    container_name: adservice-app
    ports:
      - "9555:9555"
    restart: always
    healthcheck:
      test: ["CMD", "/usr/bin/grpc_health_probe", "-addr=:9555"]
      interval: 10s
      timeout: 5s
      retries: 5

  recommendationservice:
    build:
      context: ./src/recommendationservice
      dockerfile: Dockerfile
    image: uadeel421/reliance-recommendationservice
    container_name: recommendationservice-app
    ports:
      - "8080:8080"
    restart: always
    healthcheck:
      test: ["CMD", "/usr/bin/grpc_health_probe", "-addr=:8080"]
      interval: 10s
      timeout: 5s
      retries: 5

  paymentservice:
    build:
      context: ./src/paymentservice
      dockerfile: Dockerfile
    image: uadeel421/reliance-paymentservice
    container_name: paymentservice-app
    ports:
      - "50052:50051"
    environment:
      - PORT=50051
      - DISABLE_PROFILER=true
    restart: always
    healthcheck:
      test: ["CMD", "/usr/bin/grpc_health_probe", "-addr=:50051"]
      interval: 10s
      timeout: 5s
      retries: 5
