services:
  cartservice:
    build:
      context: ./src/cartservice/src
      dockerfile: Dockerfile
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    image: uadeel421/reliance-cartservice:latest
    container_name: cartservice-app
    ports:
      - "5000:8080"
    env_file:
      - ./src/cartservice/src/.env
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:8080"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  productcatalogservice:
    build:
      context: ./src/productcatalogservice
      dockerfile: Dockerfile
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    image: uadeel421/reliance-productcatalogservice:latest
    container_name: productcatalogservice-app
    ports:
      - "3550:3550"
    env_file:
      - ./src/productcatalogservice/.env  
    volumes:
      - ./src/productcatalogservice/ssl:/ssl:ro
    restart: always
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=localhost:3550"]
      interval: 10s
      timeout: 5s
      retries: 5

  currencyservice:
    build:
      context: ./src/currencyservice
      dockerfile: Dockerfile
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    image: uadeel421/reliance-currencyservice:latest
    container_name: currencyservice-app
    ports:
      - "7000:7000"
    environment:
      - PORT=7000
      - DISABLE_PROFILER=true
    restart: always
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:7000"]
      interval: 10s
      timeout: 5s
      retries: 5

  frontend:
    build:
      context: ./src/frontend
      dockerfile: Dockerfile
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    image: uadeel421/reliance-frontend:latest
    container_name: frontend-app
    ports:
      - "8081:8080"
    depends_on:
      cartservice:
        condition: service_healthy
      productcatalogservice:
        condition: service_healthy
      currencyservice:
        condition: service_healthy
    environment:
      - PORT=8080
      - PRODUCT_CATALOG_SERVICE_ADDR=productcatalogservice:3550
      - CURRENCY_SERVICE_ADDR=currencyservice:7000
      - CART_SERVICE_ADDR=cartservice:8080
      - RECOMMENDATION_SERVICE_ADDR=recommendationservice:8080
      - SHIPPING_SERVICE_ADDR=shippingservice:50051
      - CHECKOUT_SERVICE_ADDR=checkoutservice:5050
      - AD_SERVICE_ADDR=adservice:9555
      - PAYMENT_SERVICE_ADDR=paymentservice:50051
      - EMAIL_SERVICE_ADDR=emailservice:5000
      - SHOPPING_ASSISTANT_SERVICE_ADDR=shoppingassistantservice:5050
    restart: always

  shippingservice:
    build:
      context: ./src/shippingservice
      dockerfile: Dockerfile
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    image: uadeel421/reliance-shippingservice:latest
    container_name: shippingservice-app
    ports:
      - "50051:50051"
    restart: always
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:50051"]
      interval: 10s
      timeout: 5s
      retries: 5

  checkoutservice:
    build:
      context: ./src/checkoutservice
      dockerfile: Dockerfile
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    image: uadeel421/reliance-checkoutservice:latest
    container_name: checkoutservice-app
    ports:
      - "5050:5050"
    env_file:
      - ./src/checkoutservice/.env
    volumes:
      - ./src/productcatalogservice/ssl:/ssl:ro
    environment:
      - PORT=5050
      - PRODUCT_CATALOG_SERVICE_ADDR=productcatalogservice:3550
      - SHIPPING_SERVICE_ADDR=shippingservice:50051
      - PAYMENT_SERVICE_ADDR=paymentservice:50051
      - EMAIL_SERVICE_ADDR=emailservice:5000
      - CURRENCY_SERVICE_ADDR=currencyservice:7000
      - CART_SERVICE_ADDR=cartservice:8080 
    restart: always
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:5050"]
      interval: 10s
      timeout: 5s
      retries: 5

  adservice:
    build:
      context: ./src/adservice
      dockerfile: Dockerfile
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    image: uadeel421/reliance-adservice:latest
    container_name: adservice-app
    ports:
      - "9555:9555"
    restart: always
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:9555"]
      interval: 10s
      timeout: 5s
      retries: 5

  recommendationservice:
    build:
      context: ./src/recommendationservice
      dockerfile: Dockerfile
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    image: uadeel421/reliance-recommendationservice:latest
    container_name: recommendationservice-app
    ports:
      - "8080:8080"
    restart: always
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:8080"]
      interval: 10s
      timeout: 5s
      retries: 5

  paymentservice:
    build:
      context: ./src/paymentservice
      dockerfile: Dockerfile
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    image: uadeel421/reliance-paymentservice:latest
    container_name: paymentservice-app
    ports:
      - "50052:50051"
    environment:
      - PORT=50051
      - DISABLE_PROFILER=true
    restart: always
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:50051"]
      interval: 10s
      timeout: 5s
      retries: 5
